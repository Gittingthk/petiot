# petiot

개요

기존 플랜은 “일단 동작하게 만들기”에 초점이 맞춰져 있었고,
수정 플랜은 실물 환경에서 안정적으로 유지되는 구조를 목표로 했다.

실제 테스트 기준으로 문제가 가장 많이 발생한 지점은
전원, 동시 제어(경합), 입력 검증이었고
이를 설계 규칙 수준으로 끌어올려 정리했다.

1. 전원 관련 변경

서보는 외부 전원 사용을 필수 조건으로 명시

ESP32와 GND 공통

서보 전원단에 캐패시터 사용 권장

변경 이유
서보 구동 시 순간 전류로 인해
ESP32 리셋 또는 Wi-Fi 끊김이 가장 빈번하게 발생함
소프트웨어 문제가 아닌 전원 문제가 원인인 경우가 대부분이었음

2. 서보 제어 기준 정리

제어 기준을 angle 중심 → pulse_us 중심으로 변경

angle은 편의 변환용으로만 사용

실제 제어값은 pulse width로 통일

펄스 범위 정책

기본: 1000 ~ 2000 µs (안전 범위)

확장: 500 ~ 2500 µs (옵션)

변경 이유
서보마다 실제 각도 범위가 다르고
500~2500 µs 전 구간 사용 시
끝단 떨림, 과전류, 발열 문제가 발생할 수 있음
pulse 값이 물리적으로 가장 신뢰 가능한 기준임

3. 타이밍 계산 방식 개선

tick 계산을 period_us = 1e6 / freq 기준으로 명확화

tick 값에 clamp 처리 추가

변경 이유
수식 자체는 동일하지만
가독성과 디버깅 안정성이 크게 개선됨
경계값 입력 시 오동작 방지 목적

4. Sweep 동작 및 충돌 처리

Sweep는 FreeRTOS task로 유지

명확한 충돌 정책 추가

수동 서보 제어 요청 시 sweep 자동 중단

변경 이유
sweep 동작 중 수동 제어가 들어오면
서보 값 튐, 비정상 동작이 발생할 수 있음
재현이 어려운 버그를 사전에 차단하기 위함

5. 동시성(경합) 최소화 정책

기본 정책: 단일 제어 루트 유지

필요 시 mutex 적용 가능하도록 구조 분리

변경 이유
동시에 여러 제어 루트가 접근하면
간헐적인 오동작이 발생함
문제 발생 시 원인 추적이 매우 어려워짐

6. 입력값 검증 강화

ch / angle / pulse / step / delay 값 범위 검증

잘못된 입력에 대해 400 응답 반환

변경 이유
웹 UI 또는 API에서
잘못된 값이 한 번만 들어가도
서보 고정 또는 시스템 비정상 상태가 발생함
사전 차단 목적

7. 상태 확인 정보 확장

/status에 다음 정보 포함 권장

sweep 동작 여부

전원 상태

I2C 인식 여부

현재 설정값

(옵션) /i2cscan 또는 부팅 로그 출력

변경 이유
PCA9685 주소(0x40) 미인식 문제 빈번
상태 확인 정보가 없으면 디버깅 시간이 크게 증가함

8. 웹 UI 보완 사항

기존 슬라이더 및 입력 UI 유지

추가 권장 기능

pulse 직접 입력

안전 범위 토글

변경 이유
현장 캘리브레이션 및 서보 교체 시
빠른 조정이 가능하도록 하기 위함

결론

기존 플랜은 동작 가능성을 목표로 했고
수정 플랜은 실물 환경에서의 안정성을 목표로 했다.

실제 문제는 대부분
전원, 경합, 입력 검증 단계에서 발생하며
알고리즘 문제는 그 이후의 영역이다.

